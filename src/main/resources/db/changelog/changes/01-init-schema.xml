<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.23.xsd">

    <!-- 1️⃣ Tabela: user_icon -->
    <changeSet id="1" author="system">
        <createTable tableName="user_icon">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_user_icon"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <!-- 2️⃣ Tabela: user_status -->
    <changeSet id="2" author="system">
        <createTable tableName="user_status">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_user_status"/>
            </column>
            <column name="video_title" type="VARCHAR(255)"/>
            <column name="is_online" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="is_watching" type="BOOLEAN" defaultValueBoolean="false"/>
        </createTable>
    </changeSet>

    <!-- 3️⃣ Tabela: roles -->
    <changeSet id="3" author="system">
        <createTable tableName="roles">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_roles"/>
            </column>
            <column name="name" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <!-- 4️⃣ Tabela: user_info -->
    <changeSet id="4" author="system">
        <createTable tableName="user_info">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_user_info"/>
            </column>

            <column name="username" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="icon_color" type="VARCHAR(20)" defaultValue="#f1c27d"/>

            <column name="icon_id" type="BIGINT"/>
            <column name="status_id" type="BIGINT"/>

            <column name="registration_date" type="DATE">
                <constraints nullable="false"/>
            </column>

            <column name="active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Relacje -->
        <addForeignKeyConstraint
                baseTableName="user_info"
                baseColumnNames="icon_id"
                constraintName="fk_userinfo_icon"
                referencedTableName="user_icon"
                referencedColumnNames="id"/>

        <addForeignKeyConstraint
                baseTableName="user_info"
                baseColumnNames="status_id"
                constraintName="fk_userinfo_status"
                referencedTableName="user_status"
                referencedColumnNames="id"/>
    </changeSet>

    <!-- 5️⃣ Tabela pośrednia: user_roles -->
    <changeSet id="5" author="system">
        <createTable tableName="user_roles">
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="role_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey
                tableName="user_roles"
                columnNames="user_id, role_id"
                constraintName="pk_user_roles"/>

        <addForeignKeyConstraint
                baseTableName="user_roles"
                baseColumnNames="user_id"
                constraintName="fk_userroles_user"
                referencedTableName="user_info"
                referencedColumnNames="id"/>

        <addForeignKeyConstraint
                baseTableName="user_roles"
                baseColumnNames="role_id"
                constraintName="fk_userroles_role"
                referencedTableName="roles"
                referencedColumnNames="id"/>
    </changeSet>

    <!-- 1️⃣ show_structures -->
    <changeSet id="6" author="system">
        <createTable tableName="show_structures">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_show_structures"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <!-- 2️⃣ genres -->
    <changeSet id="7" author="system">
        <createTable tableName="genres">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_genres"/>
            </column>
            <column name="name" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="tmdb_movie_genre_id" type="BIGINT">
                <constraints unique="true"/>
            </column>
            <column name="tmdb_tv_genre_id" type="BIGINT">
                <constraints unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <!-- 3️⃣ shows -->
    <changeSet id="8" author="system">
        <createTable tableName="shows">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_shows"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="root_path" type="VARCHAR(500)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="show_structure_id" type="BIGINT"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="shows"
                baseColumnNames="show_structure_id"
                constraintName="fk_shows_structure"
                referencedTableName="show_structures"
                referencedColumnNames="id"/>

        <createIndex tableName="shows" indexName="idx_show_name" unique="true">
            <column name="name"/>
        </createIndex>
    </changeSet>

    <!-- 4️⃣ seasons -->
    <changeSet id="9" author="system">
        <createTable tableName="seasons">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_seasons"/>
            </column>
            <column name="number" type="INT"/>
            <column name="show_id" type="BIGINT"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="seasons"
                baseColumnNames="show_id"
                constraintName="fk_seasons_show"
                referencedTableName="shows"
                referencedColumnNames="id"/>
    </changeSet>

    <!-- 5️⃣ media_item -->
    <changeSet id="10" author="system">
        <createTable tableName="media_item">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_media_item"/>
            </column>
            <column name="title" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="parent_title" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="season_number" type="INT"/>
            <column name="episode_number" type="INT"/>
            <column name="type" type="VARCHAR(30)"/>
            <column name="root_path" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="file_name" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="codec" type="VARCHAR(100)"/>
            <column name="audio" type="VARCHAR(100)"/>
            <column name="duration" type="DOUBLE PRECISION"/>
            <column name="video_hash" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="season_id" type="BIGINT"/>
            <column name="show_id" type="BIGINT"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="media_item"
                baseColumnNames="season_id"
                constraintName="fk_mediaitem_season"
                referencedTableName="seasons"
                referencedColumnNames="id"/>

        <addForeignKeyConstraint
                baseTableName="media_item"
                baseColumnNames="show_id"
                constraintName="fk_mediaitem_show"
                referencedTableName="shows"
                referencedColumnNames="id"/>
    </changeSet>

    <!-- 6️⃣ shows_genres (ManyToMany) -->
    <changeSet id="11" author="system">
        <createTable tableName="shows_genres">
            <column name="show_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="genre_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="shows_genres" columnNames="show_id, genre_id"
                       constraintName="pk_shows_genres"/>

        <addForeignKeyConstraint
                baseTableName="shows_genres"
                baseColumnNames="show_id"
                constraintName="fk_showsgenres_show"
                referencedTableName="shows"
                referencedColumnNames="id"/>

        <addForeignKeyConstraint
                baseTableName="shows_genres"
                baseColumnNames="genre_id"
                constraintName="fk_showsgenres_genre"
                referencedTableName="genres"
                referencedColumnNames="id"/>
    </changeSet>


</databaseChangeLog>
